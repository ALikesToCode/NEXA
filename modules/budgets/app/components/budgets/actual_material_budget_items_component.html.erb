<div class="grid-content medium-6">
  <h4><%= t(:caption_material_costs) %></h4>
  <div>
    <div class="generic-table--container -with-footer">
      <div class="generic-table--results-container">
        <table class="generic-table material_budget_items">
          <colgroup>
            <col opHighlightCol>
            <col opHighlightCol>
            <col opHighlightCol>
            <col opHighlightCol>
          </colgroup>
          <thead>
          <tr>
            <th>
              <div class="generic-table--sort-header-outer">
                <div class="generic-table--sort-header">
                  <span>
                    <%= MaterialBudgetItem.human_attribute_name(:work_package)%>
                  </span>
                </div>
              </div>
            </th>
            <th>
              <div class="generic-table--sort-header-outer">
                <div class="generic-table--sort-header">
                  <span>
                    <%= MaterialBudgetItem.human_attribute_name(:units) %>
                  </span>
                </div>
              </div>
            </th>
            <th>
              <div class="generic-table--sort-header-outer">
                <div class="generic-table--sort-header">
                  <span>
                    <%= MaterialBudgetItem.human_attribute_name(:cost_type) %>
                  </span>
                </div>
              </div>
            </th>
            <th class="currency">
              <div class="generic-table--sort-header-outer">
                <div class="generic-table--sort-header">
                  <span>
                    <%= MaterialBudgetItem.human_attribute_name(:costs) %>
                  </span>
                </div>
              </div>
            </th>
          </tr>
          </thead>
          <tbody>
          <% budget.cost_entries.visible(User.current).includes(:cost_type).group_by(&:work_package).each do |work_package, cost_entries|
            entries = cost_entries.inject(Hash.new)  do |results, entry|
              result = results[entry.cost_type.id.to_s]
              unless result
                result = CostEntry.new(cost_type: entry.cost_type, project: project, overridden_costs: 0.0, units: 0)
                results[entry.cost_type.id.to_s] = result
              end
              result.overridden_costs += entry.real_costs
              result.units += entry.units
              results
            end.values
            entries.each do |c|
          %>
              <tr>
                <td class="subject"><%= helpers.link_to_work_package work_package %></td>
                <td>
                  <%= link_to helpers.localized_float(c.units),
                              cost_reports_path(work_package.project_id,
                                                'fields[]': 'WorkPackageId',
                                                'operators[WorkPackageId]': '=',
                                                'values[WorkPackageId]': work_package.id,
                                                unit: c.cost_type_id,
                                                set_filter: 1) %>
                </td>
                <td><%= c.cost_type %></td>
                <td class="currency"><%= c.costs_visible_by?(User.current) ? number_to_currency(c.real_costs) : "" %></td>
              </tr>
            <% end %>
          <% end %>
          </tbody>
          <% if User.current.allowed_in_project?(:view_cost_rates, project) %>
            <tfoot>
            <tr>
              <td colspan="3"></td>
              <td class="currency">
                <div class="generic-table--footer-outer">
                  <strong><%= number_to_currency(budget.spent_material) %></strong>
                </div>
              </td>
            </tr>
            </tfoot>
          <% end %>
        </table>

        <div class="generic-table--footer-background"></div>
      </div>
    </div>
  </div>
</div>
